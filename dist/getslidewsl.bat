@REM
@REM SlideWSL
@REM
@REM The Simple Linux Interface for DEveloping on WSL (Slide Whistle!)
@REM
@REM https://github.com/davehasagithub/slidewsl
@REM
@REM -----------------------------------------------------------------

@echo off
setlocal enabledelayedexpansion

set startTime=%time%
set tempProvisionPath=.slidewsl
set encodedTgzFile=assets.tgz.enc
set tempProvisionScript=_slidewsl.sh
set distro=Ubuntu-22.04
set distroExe=ubuntu2204

if "%~1" == "" goto ShowUsage
if "%~2" == "" goto ShowUsage
goto Continue

:ShowUsage
echo Usage: %~nx0 ^<username^> ^<password^>
exit /b 1

:SubsystemFailure
echo Install failed
echo See: https://learn.microsoft.com/en-us/windows/wsl/install-manual
echo Ensure feature is enabled: Windows Subsystem for Linux
echo Ensure feature is enabled: Virtual Machine Platform
echo Update: https://apps.microsoft.com/detail/9P9TQF7MRM4R
echo Install: https://apps.microsoft.com/detail/9pn20msr04dw
exit /b 1

:Continue
set "username=%~1"
set "password=%~2"

echo user: %username%

set "WSL_UTF8=1" & @REM https://github.com/microsoft/WSL/releases/tag/0.64.0

wsl --status >nul
if errorlevel 1 (
  goto SubsystemFailure
)

set num_chunks=0
set num_chunks=8
set "asset_encoded_tar_1=MWY4YjA4MDAwMDAwMDAwMDAwMDNlZDNjNjE3N2QzYjhiMjdjZjZhZjE4ZGMyYzZkNTgxYzI3Njk5YWVlNmQwOTk3MDI1ZDFlNjc4MTcyMjhiZDljZmI0YTZmOGU2MzJiODliNjhlNmQyY2I5NjkyOWJkYmZmZGNkNDhiNjYzMjc2OWMzYmU0M2NiN2I1YzRmMjE3MWE0OTEzNDkyNjY0NjIzNjljNjBkZmJkZWFkNDMxMzYxN2I3YjliYmU1YmRiNWJjZGUyNzcwNmY3NWE5ZGVkNmU3N2IzZDllZDc2M2I5ODhlY2ZhZDdiYjA3NWZiYTRkZGJiOTcwOGU5YzQwMGY3M2NlNzhjZGQ4NGI3MmFmZmZmMjkzNGVjYTlmMDZmOTkwN2ZlZjJmY2I3OWE5ZDZlYjc5YWZmYmIwMDNkZmYxZTE3YTcxNjlmMzgyM2Q2MTAyYzNlZTNlZTc3ZWRlYWFhZjlkZmRhZGE5YWNkN2YwYmQzNWI5ZDI2Yzk3ZmYzN2IxMjcxMWRmYzg3Y2ZmZmYxNTFjMGU1ODlmMTgyMDkzN2U2OTFlNDYxZDA3YmUzMDRjODA4ZjA5OTRkMTIyYjE4NzhlMDMxNjIwOGUzYTMxMzQ4ZDEwYjk4OWM4NmYxYTkxNTA2M2UwZjU4MDNjNzZlYzRhNGIxMzc5NDJjYmUyNmNmMzgzZWQ0MmM3NTYyZWMwNzY3M2MwZTgzMDkwYmU0ZWZkYzY3M2Q5YjQ5YjdjODdiNmUxODBjOGQwZjE3MTFlYjg1MDExM2UzNTAxYWZiZTdjYzNkYzQ4YTY0Y2Y0ZTQ0NmNmYmExZWJmOGY2ODAwN2I2ZjBiOWM3OTA3NWIxZTRhODIxYzY0MGIzOThhMTg3ZDE2YWVjMzAzMmRlYjM4OWMzMDM0NWZhZmUzOTk3YmQwYjI2OGMwZjdjYzJjMjQ0NTIxZDg3Y2NlZDZkMzY4NWVhMzdmMzllNWRmNGM2OGUyZmQzNGU4MTE4MjdkMjBiYTdjMWFjOTNhZjAyMjRjMWY3NGY2NmY4OTNjNDk3ZGM0YTUwYTAzMmFjMWYzZGQ5NGI2MDUxZmVjN2RmYmQ4ZDE1ZjJkZjZkYjVlN2Y1ZmY2NjczYjM1YmM5ZmY1ZGMwZGE3ZDI1MmEyNDI0MmMzODgzODEyM2M2ODZiMTA2NjMyOTIzYjE2M2RiNTMyNzE4N2RlMTlmNzkxYmU3YTQzMWUyNzI5YzBjMWEzY2I0NTFkNmI4ZWIzM2JiZGQ2Y2I3ZWRlNmE2ZGRmYzliYWRkNDg1M2I2NjhlYjRjNDk4MzFkOTE4Y2I4OTVmYWM2OTNhNmQwYzFjZTY3YjQ5MzA0MjQxOWZkOGE4MjM5Mg=="
set "asset_encoded_tar_2=NzM3YjEyMjY4MWI0M2ViYmUxYjRhZDE5ZDAzMDNjZTZmYTRlY2NjMDcyMjBlMjllMzAwYzE0OWQzZTNkNmRkNGUxZDIwMDU4MDMzOWU2MDI5YzI4OGE0M2M3MWRjMzkwMDc5ZTUwYTgzMGUxNDIzMDBmMDYxN2UwOGI3MDA4NGVlMGMxOTAwNDEwNGIyOTY1MDA2ZTEyYzdhODdkYTgzYTU1YTIzZmM1M2VmNTIzODcxMmIxMzgxMTIzMTBiOTgwZDZhYmQ1MzA2MTAxYjc1N2RiODgwNDU4NDg2NTQ4OTkzZGY1NGQwZjc1YzQ5ZThlNTFiYjQxY2MxYzBmYWMxODU0NWJmOGIxMGI1ZTg4OTkwMDdjMDhmN2UxMTI4ZThmYTE0Njc5MTZmYjBjYjUyMjYxNWZiZjYyYzZkMjljOTMxM2NhMWNjNTJjMDJlYjMzOThmZjZkODI2OWUzMjhiODM2NTU2NDIzMjdjYjQ0OThiYjcwYjU4YjQzYzQwMmQ1MThhNGJkNDI4MjlkZTkyOWFjNWY0NjMxMGYyNGQ0NWE1N2ViYTVjMjFhY2JhY2E3ODU5MDQ2ZTY4ZTQzMzA2YjY5MDYxNGRhYjU3MTQ5YjA3MTY5Njg5YWE1ODZmNDMwZmRkYWRiMzBhOWM2YmNhYTIxMzdmMjJmMGYxNTNiM2M3ZWZjMTgxNDRhNzk0ODRkNjgzZmQxMzUyN2JlNmY1YzExMWIyMjI3ZjkzZTMyOTU3YjBhYThhMjljMDFhZTE5ODdjZmRiY2RkZmJhMDY2OWYwM2VhZTE3MTI1NTM4OGIzM2Q2ZDA5MzRjNGMwM2Y0ODk3ZGY2NDJmNzk0ZTExY2UwNWM3ZDI2ODI3NGE3MmM5ODE1ZGQwMTEzNmE2OTkxMjE0ZDhhNDliZjRjMWNlYjQyZTdkMjZhZjI1MjZhMDU1MWM1NjA0NjMzZDJmZmEwNDUxMzI0ZTM4NDE5YWFjN2Q4OGI1M2VlZmI3ZDFhZTczMjkxOTE2ZTcyYWUxZjI5YWJmNTM2ODhkNjhjZWYwYjY0MmIyZWY3Yjk5MDQ0YjU1OWJiYTRkZmM3NGY0ZmFlY2M5Y2ZhZGFlNTVhOTYwOGQ2NDg0MmIzZGM5MTYxYTgxOTkyMDdhNWUyMzk2ZmU2ZDViNGEwZDcwMzEzZDE1ZDM2MzcxNjA0MTkzZGQ0MzliMGZlYTYxOGQ5Y2M3M2IzNTRjZDA3YTU2OTRkOGJmYjgyMmRhZjZiNDk0NWQ3ZDY5MjMyMTZmMTk0N2E4ODk5NGNlMjAwOWE0NjlhOTVmZTZlZDEyY2QwMzhlN2ZhNDMyNDVlYTg1NDFkNTgyZTk4ODllMjcwYzg5OTdhNzc2Ng=="
set "asset_encoded_tar_3=ZmE1ODE2YjIxZGNlNGVjMGRjMDI0MjNhZDhmNzYxYjE2NDNlNDg1OWE3NTI5NGExODMxYTQxNzUyY2VmZmExYzQ2Nzg2YTZhYmFiM2NhNTcxMGIxYTRhZDAyZGEwZGVkMTViMDhhNmQ2NmQ5MzQ1MDExMGY0NjQwMmNjYjUwOWQwYTZjYzg5MTQwMWEzOTExOTQ1MTE4ODIxOTZmMmYyMTQ3YzkyZDE1NzA0NmM4ZGNjNDcxYWRhNmQwNzMyYjdjODZhYWE0NjU2NDczYWNlYjAwYzU2ZGI5ZTAyODkzMmU5ZDMzY2Q5NGY3YzExYTIyM2JiYzdhZjNiMmZmZmFlMGY5ZGU4NzU3MDc2ZjRkNzhmMDgwZDJiZDg1ZjQxMmNmYWFjMTQ0ZTMwZjVjZDRjYTkyNTEzZDZhY2Q1OTI4ZDU2ZWJlMmM3NzQyZTNhYmE1Njk0N2IxZGFkMjQxMmRhMzM5M2VlOWZlMGI2MGU3MjhhOWEyMzRhZmI5MGVmZDU3M2U5MzI4Yzk1YTBmNmI0ZDRiMGEwNGZiOGE0YjhiMmQyZTg0M2Q0MDc1NzFhYWYwNmNjMWJmMzBlYWFlNTlkYjcwNzE0Njk2NjYxN2E0YTQ2ZWMyN2QxNGUxZTZkYzUwMTQzNGEwNjIwMjJjM2JhMzM4NGQ5YzYzOWQwMjJiYTYwOGJkMDJmNWU1MTFiY2JlOGQ2Y2YwZjQ1ODBjNDU1ZjkyYTU1ZmRiMThmOGE3YjRkNjA5ZjhmMGNmNzdmYmI0OGU5ZTM5N2VjMjY2OWM1ZTJmNjhlNmI0OTRhOTk0ZDM1Y2M3MjZhNzQzZDE2MGU3YjI0M2UzOWI5NzVlMzY0ZDQzNWE5ZTcxZjQyNDliYWM5ZWQzMTI3Mjc5NjZjMTExYTg2ZjUzOWFhZTY2N2Q5YjljN2EzYzA2MmI0MjgyZGYxYzFjYmRmZDUwMWExZDI1ZGM1YWU2OTcyZGE5MTAwNjMwNWZhYWQ4YzliMmM2NTlkYWMyYWMwYjBhMWI0NWYwODY1ZWNlNTBiMmJlYTkxNGNkMDFiYTNiZWU3ODEyN2FkMDQyMTM3ZTY5NzNiOTIyOGIzYzFhYWY4OGM1NjQ4NmUxNGU1MjY0Y2RhMjMwNmI4NTk0NGFiMzJlYjExZmM3NjFiYzAzY2ZjM2M5ODQwY2I1NGY2NmVkZDlkZWUxN2ZmNTlmMWZiYzc5YjNmN2Y2YzUyNzMzNTU2MjQwMzYwMjBkYjg0NDc2ZjIxOGQ0ZmU0ZThkYWVhOTA0YTVkYTY1ZWM0NGIwYWU5MWQ3NjFmZmZkN2JkYzhkMjk0NWIxNmM3Yjg5M2M0MzIyMjRjMjA0NTUwZDJjZGQ4MDFhZWMzYw=="
set "asset_encoded_tar_4=MGE2MzA5ZTU5ZWY2ZWM0OTIwZjM4ZGE0OGQ1OGRhM2M2YWUxMzJmMzM5NjE0MmFhYTU1NTU1MDNjNzI1OTEzODMxODkxZWI1ZGUxNjkzYWY4ODE0OTRmNWNiN2MwMDc1NjEzZTBhYzIxODg3N2Y1N2Y3Yjk4NWU2OWM2MWUwMDRhMDhhMTgzMDkyMjQ5ODM4ZTc2NDMzYzlkZTZmODZlMTNhODIxMTE1MjZlYTU3NjU0ZTYwYmEzNmJjZjQ4ZTk4OWU3Njc3NTM0MzIzY2JjMGNkNmY5ZWZlYjA1ZTYwODcyM2ExZjQ1N2FkMDk5N2FhZjg1N2MyYmQ0YTc5NGEwZjc4NWE5MDA5YzdjZGM2ODBlNDdjMTJmOTRjZTI1NGZmZThmZDRjMDU3ZjBkZDJmZGJmMzI2ZjQ5YjkwZmY5YThmMWE3MDg4M2VmZDljNmNhZjNkZmNkZWRjNWYzYmZhZDZhZmY3ZjE3NDBlYWQ4ZjQ5OGM0OGRmNDFmZWM0Mjk4YjhhZjcwNjVlYzViZWM5MWQyZGIzZjlhYmMwYTZlMTk0YWYyZWYzOTZjMTIwNjc3MmZmZmRkMjVmMjVmOWRmZmRkMDkyOGY5MWY4N2I0NGRkOTgxNjNiNWJhOWI0OWMwY2Y3NzZjZGIzZTczNjIzYjRlODI5NDNiMWEwMmJmYzgxNDM4YTlmNGMyY2YwMzI1ZjkwZmNmNTgxY2EzODFhYmVjZTBlZmQ3YzYyYWY5NmY2ZDJlZGNmZjc1NWFlZDRhZmVlZjAyMGE5NzczZjk1NWRiZmNhZDFiNWQwZTY4MGU0OTRmMDBmNDYxYTVkNzUzZGE2MWY2YmJmMGE4OTQ0NWE1MjVmZWVmODM5NmZmNDkyOGJkZGJiOGY5ZDNiMDRhZmVkYjlkZjZkY2ZkNWY2YmJiNWFmZmVmMDZkMmQzN2U4YjBlZDQxZWYyODdjNTEzMzUzYTYzN2NmYzc4ZmZlMDc3ZjgwYTc0YWI2NjBhZmI1ZmYwZDBiNjRkYzA4NGI5MGI3NjFhOWQ4OTRmNTdlYjc0ZWE0NTU2YzJlMzhmY2Y5ZTNkZjkwYTQ1Zjg1YTRjZmVjODdjMzc5Y2IwZjllNDIyMzYzNjZkMGNmOThmMWVhMTlmMWJiNGZjYzc0Yzg0ZmVkOTc3NWVmNjczNTg2OWZmNzdiYTczZjJkZmVlNmU1NWViZmY5ZDQwZTA0YzE4Yjk3Y2IxMTg3ZTZiYTgzZmEzOTBkNDZhYThiZjZhMjFmZjY5NDFjYjNmYjk0NjM5M2U3NzA0MTNiNzYwMDZhYzk0ZmZhZDA1ZmY5Zjc2YTc1M2M5ZmY1ZDgwOWE3NWQwY2I3N2NmYmM2ZTU1YWZjZQ=="
set "asset_encoded_tar_5=ZjU3ZjU2OThjOTNmMGJjZTZlNjkwYmIwNGFmZTM3M2I1YmYzZWI3ZmE3NWRhZGZmNzcwMmU5NWRlNzhiODNlNzdmZWNiZmVmM2YzYjdhZjVmYWM1MWZhZjNlZjQ1YTg2YjE5NjY2M2QzZjc4ZjNlZWUwNzBiZmZmZmJhYmQ3ZmJiZDg1ZDRmZGI3ZmY1MDM5ODczZGMzZjg3OGY4YmE3ZmY0ZWE0NWFmYjY0MWY3Zjk0OTVkMjViY2NjMTM0NmY1ZWM2NjM1NDUyY2ZlNDQzNDU1NDFiYmZmNzJlZmMzZmVjN2JkN2Y1MmExMDhlMjMwOTEwY2M0Mzg5Y2U2OTdlNTFjM2MzNjc0MTI5ZmFlY2ZiNTQ3MWJhNDJlNmQ5YjU3ZWJjNTI2ZjJhYTJhZTU3NTNkY2NlNGZmOTRiMTA4NTc4MzMzNjY0NTcxNDg0ZTBmZGZlZDQ0NjBiNWZkM2Y3ZmZlYjdiNTU5ZGRmZmRkMGQyODU3YjhiOTY1YmZjNDBkYzgwNDk1ZmNmY2JjYjA0NGZlYmZiYjE1YjAzMmZlYTdkNTljOTNmZmNkYWQ2ZWIzOTJmZmJiODA4ODdiN2Q1MmY2NjhmYmNiNDkzNGM3MDhjYTE3NTdmOWMwMmI4NzQzZTU4OGFiYjA0YmRlYjg5OWM3NzNkZDUwMGVmMDJkODNjZTE0YjVjMzkzNzJkYzlkOWQyODQ2YmEyZTcyYzY0ZWJkZTViNTkzOWM0MmNiNTZmMzk5N2Y3YWRkMTg3MmFhNGM5Mjc3OTVmNTI1NDdmY2FhNTNjYzczZTUyNTZmNDIwZjFmNWIyYTFkZWUyYjRmZWZiY2NlMTk5MTM5MGRkZTIwMTE5NmVmMjQ4MTNiY2VmY2I0MjlhOTlmOTJhNjZkOGM0MGEzZTlmYmYwOTlkYjc4MmRjM2M0OWEwYjgzNDE2NGZlZTg3OWZjZGZjMjRjZmUyM2QxZmE0MWY2N2Y3M2UxZmVhZmJkZDlhZWU0ZmY0ZTIwMzU5N2RmMWRiNjdhZTZmMWE3ZTQyOTcyMDI3Y2ZhNzhmMmU5NTMwZGFhNGRmZjdmMDA2OGY5ZWY2NzdlYWRiN2EyMDE2ZTk2ZmYxNmMyZmNmOWZmNjZiM2JhZmZiZjFiNTgxYWZmNDc3MWIxYTlhYjc2MWYzNzA1M2VmMDgwZDNmMmZmZDRjYzUzMTA5MWY1Yjk4ZTc5MTU3OTJhOTkwZTdkOGYwYjE5ODdmZDM4MDkwMjFlOGMwYTc1MjhlNGJlZjYyNDU4NDgxNjYyZWNlNTg5ODJjOTdlMTJmNTkxYTJmOWE0NjBiMDgwMjU0ZTk5M2Y5ZmE2ODJmZWFlMGM4MzA4MmY4NDkwNjAxZg=="
set "asset_encoded_tar_6=OGUwZWY3ZGZlYmMwODgzODBjNjVkMTNhOTlmMzRiYTcyYTgwOGI2MDVkODJjMjJjM2I0MWU3MDExZDE0YWFmMTQ1N2I2MGEzMDFhMjFlZGJiM2M3Y2RhNWMxMTczMzM3ZWJjN2Q0MGE1ZGI4M2M4MWM3OTEyM2M0MzQ4Y2JkMjczYTM1ZGI4NjViYzNkMGY3NThmYzY0MjkwMTZiYmFjNjc1ZTVjMWI1YTM2MjE1MDQ3ODgxNTg4NzI3ZGFiOTNkYzAzYWI5NzRjN2RhYjU5ZDBhMjQzZTlmNjAxZDE2ODVlM2I0M2IyYWY0NDdhZjAxMTkyOTNkZWFjYzJjMzkyM2FiNDcxZGMzNjQ0MmViYTdiNGY1MzU2ZDY4MzhhMWVlODgxYzM5NTY1ZGFlOTdlYjljNDNjNjRjYWMxMWE3MjkyZDZiYTJkNTM1ZjVlYTg1MTY4YmQ5NzQwZmVkYzFiZjY5NDBhOWViMmExYzgxY2NiYjIyNGVmMWZhZDJkNGRkYTZiOTJmYjE2OGNhMDQ0ZTI0MmQ4YWRmNGU5M2MxYmE4MDJmM2M4MjI0YTBjZjExMGUwYjA5ODA5NWJhYjNmMzMwNDA0YmQzMGYxMDlmYzY5N2M2MDY2MjcxMTFiODNhYmFmNGNmY2YzMDBhN2QyNzE4ZTlmODk4NDQ3MjVmNDAxODMxMWNmMmIxYTUyZmQwNzQxNGUzNTE5MDg4YzQ0MTk5NjFhZTgzMDM1MjMyNDEwM2M2M2MwMTMyYzQ0YzcwYzAxZDczZGYwM2FjMWIxOTA2NjgyOTU2ODI5NzQ2NjIzNTQwODQ4ZjYwY2FjMDc1ODgyOWE5MjYxZDk2ZTIzZGMyNDYxYzc4MWFiMzAxMzIyYWI4MzFkMmZkNjczODc4NDQzNWE4NDE4MTYzY2EzODgxOGQyOTBmYmM3MDJhYTBkNTgyMzBmMDJmZWE4ZjIwOGM0OTY0MTJlZWMxODYxNzMyYzVlZDRlMTRmOTE3NDQ5MjhhYmUwNGZkNjIwMDUxMzc5NjA4NzczYWFhOGIzMzcyZWQ4MTUyM2EzZjY5NGFjMzViM2M2YzU4NTk5ZGFlYTU3NDY0OTEwN2E5NzQzYjlkNmY2OTQwZTE2ZTZmNmRhZDNjZjljODI0NzZlZmY1NmJjMGZmYmQwZGZjYThjM2RiODM3NzdiODc4NzFmNWZlY2FjMmE0ZmJiMWE3NWMyMjI5OThhNjc1NmE0NTEwMjhiYzUzYzY5Mzk1ZDlkNGU3MzE1NjI2MzY1MjdhZjhhNTFkY2E4NzJiMTE2ZWRjNTQ5YTFkNzJjMThmMTgwZDlhOTEwZDhjOTIwMDk2NDYyYWYyZWEwZjc0M2Y2MWFiMg=="
set "asset_encoded_tar_7=OWU4NTFjNmEyOWFkODNlZDVlNTgzYzQ4Mzc0YmU0M2I2YzUxYzQ4ZTk1ZjI2NmExNTZmMjJiNmQ2MDkzNThlZGI5M2I0NmMxNjFhYTcyYzdlZTc0N2Y2Yjc2Yjc4ZGYyMGFhMTc4NmJiOWM4YmE4ZWU1YjI1OGYyMjFjNzZkMjkyYTNjMzc4OTY5MDVjODMxMjZkMGE0YzliNTNjM2Q0YzU4ODM4ZDQ0ZTJiZTcyOTQwNjc3MjNjZTUwMWNiZTJlZjQ3NzFhZjhhMWUzMTVmYmFjZTNkM2QzYjExOTQ1MjNkYWIzMmU1NDk3ZjljNjNhYzJjZGU3Y2ZmOTM1YmUxOTUxYTllMTNkY2Y1MzUyOGVmYmNkNTA3MDE5YzY0YWU0ZjYyMjk5YzYyNjg5OWQ4Y2Y5M2U2OWFmNWM4ZjBkZTBkODg5ZGQzMTQ1MzU0N2E3NDg4ZmE1YjZjYTE2YTU3MWM5NWM5OWM0YWMwZTgyOGYwMmU2NTk4MzhiZGU0ZDM0OWM3YzczZDdkM2U2NmIxYjI5Y2Y4NWMyOGE5OWNmMjhlY2U4YzE4MzZjNWY3Yzc5ZjRlY2U4ZWQ4N2EzZmVmMzgzMTdmYjZmZjdkZWVjZWY1OGI1N2ZlY2JmM2Y3Yzc1ZjAzNjRmYmEzMmViMTQ5MjM0YTBjMzgzYWY2OWE1MjQxNTM5OTU2OWI3MWIxNGRkOGMxYzlkOTI0M2JmNjgyZDJiODRmZTY2MGNhMWUzY2RhZTYxOTEyY2EyODVjZDllMmNkN2U3NTA3MDUxZTQ2MTk2Mzc0ODUwZWQ5ZTViOTE5ZjIwOWJlNzA1NzAxMTA4OTFkMTc1NmEyOWFjNGY4NzhkNjU3NjRjMzkzOTY1ZmJmNDNiZjc5ZGQ2NWU5NjBkNmZhOTdhNWI3NGJmMzc4YjZkZDg4NThjOWJjYTk3ZGM3N2NkNmYyMmM3MmU5NTU5NTRhM2NiMDkyOGUzZmNkNTI2MzQ5ZTJiN2Q2MDAxZjEwMzMyNzIxMDRlYTE1YzRlMWI2ZjMzZDMzMDVkNjljODBmY2Q4YWI5ZjI0NTViZmJmYjNiYjIxNjFhMGY2ZGY1ZGQ2ZWI3MzdlZGFjZDc2MjRjZmZiZGJlOGU2ODJhMzU4YWM2MDJiOWI2ODIzMjM4MjljYzM4YjczNTZmNWNjZGY0ZjVlOGZjZjI3NTJkYmEzZTRkZjk2NmY0OTlmM2M1MzcxNTQ5ZmQzNTk3ZTFkZWI0MGNlYTNlYWNjMmQyYTRhZmMyOWE1MTdjMTM2NjRhYTg5MWFiNWRmMTVhZTlkMWViYmMwNzMzYWQxNDNiZDNmNDc1MjM2NDQxOTJkMGIyNDAyYWRkNDRiODYzMDcwZA=="
set "asset_encoded_tar_8=Njg5NTliMTZiNTY5YzczMmFiZTZhNjI1N2U4NjM0OWI3YmRjNTQ5NDIyNTM4YjYxOWFiZGRhMTIxYjM2OGYwM2VkNmIyNWQ5ZTA5MzExOWQzNjJlMGIyNzVkMmFiMGM1ZjdlZGNjMWIzM2YzNmYyYmJhYTkzNzRiNTA2ZjZjNGMwYmQ3NTJkZDcwODM2NDJlNTQ1MDE4M2JkYTdkZTUyZjU2ODg2Mjc2ODYxMzQ1NWE3NmU4NzM1N2VhZDg1ZGY1YTYwNTlhYzMzODQ0ZWVkMmFmYTA0MDQ0MWUyNjgyMjI0NzI5ZmE3NzUxOGQ2MmI1NzYyM2Q3YjEwYmJkMzI5N2M0MmMyZTk2YjQwYmI5NTg4YjBjMTMzNGI5MGI1OGUzNDQ4Y2ZkMzA1NWVmN2FlZTY5Yjc4MTUzZjlhNDgwNDVmNGM3ZWU2ZWExZDNjNDEyNjlhN2U5ZDFjMWI1MWM4ZDBlNGI4MDlhMTRkNTVmYjM5NmVkYTc0Y2IwNWU0MmRlOTM3NGM1Y2MzMjc3NmFkOWZlOGE5NjQ1NzdhYzdlNzljNjIyZTIzMmYzMTM3ZmNkNWI5OGU2OWNlNTM4YTNhMjY0NWZkZTgwYTYyYzQ3NmIzNTE4ODZkYTcxYTdjMzMwYzRkZDRjYWY3NmQ5ZGFiMWFlNTRiNGYxOTgwZjI1M2Q4Yzk5ZTNkMTNiMjBjYzFhNjExMDExZWE0MTFmMjZkYzQyNWNmODJjMmMzYzZkYjlmNGQyMTVjOWE1Y2Y3YWI1MTYwZWQ5MjA3ZDZlZTNhODM4Yjg4M2RkMDQ3YTY5NTk3NjRlYTAzNmVmOTQ5MTFmMTA2OGI0ZjVhN2ViYmJmYWU1MjI4NDRkMTcwNjY0ODIwZGMxZmNhNWI2YjE1MWJiNWM1Mzk1NWVmZGRhYWRkN2M1YTc4MGU2NDZjNmY0YTI5NmFjMzJkYTE5NjcyNTNlMDVmNGY3OGJhMGZmYmYwODUwZmZkNDg3NGVkNDdmNTQ5MjVhY2E2YjI4N2NhYmI2OTY2NTY0OWRjYjBiZmY4NTM5NWQxMjRjNGZiYTU1Y2QxN2RhNjE0ZjM2NTIzZWZiMzcyOWY5MzM0ZTYxZmUwZDk0YTBiYTdhZjc0ZDc1NjA1YzQxMDUxNTU0NTA0MTA1MTU1NDUwNDEwNTE1NTQ1MDQxMDUxNTU0NTA0MTA1MTU1NDUwNDEwNTE1NTQ1MDQxMDUxNTU0NTA0MTA1MTU1NDUwNDEwNTc3MGFmZjAzZDMyMzgwZTAwMDc4MDAwMA=="
if %num_chunks% equ 0 (
  echo Missing companion assets.
  echo Do you need to do a build?
  exit /b 1
)

wsl -d %distro% true >nul
if not errorlevel 1 (
  echo %distro% already exists. do you wish to delete it?
  choice /C YN /M "Enter Y or N:"
  if errorlevel 2 (
    echo Aborting.
    exit /b 1
  )

  wsl -l --running | findstr /C:"%distro%" >nul
  if not errorlevel 1 (
    echo Unmount disk image
    wsl -d %distro% -u root -e bash -c "systemctl stop disk-image || true"
  )
)

@REM clear any pre-existing known-hosts entry on 2223
ssh-keygen -R [localhost]:2223 2> nul

wsl --update
wsl --set-default-version 2
wsl --unregister %distro% >nul
%distroExe% install --root
if errorlevel 1 (
  goto SubsystemFailure
)

wsl --set-default %distro%
wsl -u root -e bash -c "echo -e [user]\\ndefault=%username% >/etc/wsl.conf"
wsl -u root -e bash -c "echo -e [boot]\\nsystemd=true >>/etc/wsl.conf"
wsl -u root -e bash -c "echo -e [interop]\\nenabled=true\\nappendWindowsPath=false >>/etc/wsl.conf"
wsl -u root -e bash -c "echo -e [experimental]\\nsparseVhd=true >>/etc/wsl.conf"
wsl -u root -e bash -c "echo -e [network]\\ngenerateResolvConf=false >>/etc/wsl.conf"
wsl -u root -e bash -c "apt update && apt install -y dos2unix"
echo wsl shutting down
wsl --shutdown

echo gathering assets
rmdir /s /q "%tempProvisionPath%" 2>nul
mkdir "%tempProvisionPath%" 2>nul
copy NUL "%tempProvisionPath%/%encodedTgzFile%" >nul
for /l %%i in (1,1,%num_chunks%) do (
  echo|set /p="!asset_encoded_tar_%%i!" | wsl -u root -e bash -c "base64 -d >>%tempProvisionPath%/%encodedTgzFile%"
)
echo extracting
wsl -u root -e bash -c "xxd -r -p <%tempProvisionPath%/%encodedTgzFile% | tar xzvf - -C %tempProvisionPath%"
wsl -u root -e bash -c "find %tempProvisionPath% -type f \( -not -name *.enc \) -exec dos2unix -ic0 {} + | xargs -0 dos2unix"

if not exist "%tempProvisionPath%/wsl/%tempProvisionScript%" (
  echo %tempProvisionScript% script is missing.
  echo Aborting.
  exit /b 1
)

echo provisioning
@REM -----------------------------------------------------------------------------------------------------------------
wsl -u root -e bash -c "cd \"%tempProvisionPath%/wsl\"; bash \"%tempProvisionScript%\" \"%username%\" \"%password%\" \"%userprofile%\""
@REM -----------------------------------------------------------------------------------------------------------------

if errorlevel 1 (
  echo Aborting.
  exit /b 1
)

@REM needed for \\wsl$ to pick up the new default user
echo restarting wsl
wsl -u root -e bash -c "systemctl stop disk-image || true"
wsl --shutdown

wsl sudo /usr/local/bin/wsl-keepalive.sh

rmdir /s /q "%tempProvisionPath%"

(
  echo. HIGHLIGHT1="\x1b[33;44m"
  echo. HIGHLIGHT2="\x1b[32m"
  echo. NC='\033[0m'
  echo. echo -e "\n----------------------------------------------------------\n"
  echo. echo -e " Done!\n"
  echo. echo -e " Start: %startTime%, End: %time%\n"
  echo. echo -e " For a terminal: wsl or %distroExe%"
  echo. echo -e " For ssh: ssh %username%@localhost -p 2223\n"
  echo. echo -e "----------------------------------------------------------\n"
  echo. echo -e " ${HIGHLIGHT1}Edit %userprofile%\\.wslconfig to keep vm alive:${NC}"
  echo. echo -e " (Requires a wsl --shutdown)\n"
  echo. echo -e " [wsl2]"
  echo. echo -e " vmIdleTimeout=-1\n"
  echo. echo -e "----------------------------------------------------------"

) | wsl -e bash -c "tr -d '\r'" | wsl -e bash

endlocal
